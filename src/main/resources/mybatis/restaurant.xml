<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.mvc.restaurant.RestaurantDAOInter">
    <select id="checkID" resultType="int" parameterType="String">
        SELECT COUNT(id) as cnt
        FROM owner
        WHERE id=#{id}
    </select>



	<!-- 기존 create-->
    <insert id="create" parameterType="dev.mvc.restaurant.RestaurantVO">
        INSERT INTO restaurant(restno, name, tel, ownerno, categoryno)
        VALUES (restaurant_seq.nextval, #{name},#{tel}, #{ownerno}, #{categoryno})
    </insert>
    
	
    <select id="nextval" resultType="int">
        SELECT restaurant_seq.currval AS restno FROM dual
    </select>
	
	
    <select id="list_search_paging" parameterType="java.util.Map" resultType="dev.mvc.dto.RestDTO">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    WHERE s.name LIKE '%' || #{word} || '%'
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    WHERE s.ownerno LIKE '%' || #{word} || '%'
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
    </select>


    <select id="findByOwnerR" parameterType="int" resultType="dev.mvc.restaurant.RestaurantVO">

     SELECT *
     FROM restaurant WHERE ownerno = #{ownerno}


    </select>

    <select id="list_search_count" parameterType="java.util.Map" resultType="int">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE name LIKE '%' || #{word} || '%'
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE ownerno LIKE '%' || #{word} || '%'
            </if>
        </if>
    </select>
	<select id="list_all">
		SELECT *
     	FROM restaurant 
	</select>
	
	<!-- 변경 예정 create-->
	<!--
	<insert id="create" parameterType="dev.mvc.restaurant.RestaurantVO">
        INSERT INTO restaurant(restno, name, tel, grade, address, lat, lng, reserveRange, ownerno, categoryno, botareano)
        VALUES (restaurant_seq.nextval, #{name},#{tel}, #{ownerno}, #{categoryno})
    </insert>
	-->
	
	<!-- 식당 조회 -->
	<select id="read" parameterType="int" resultType="dev.mvc.restaurant.RestaurantVO">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano
		FROM restaurant
		WHERE restno = #{restno}
	</select>
	
	<!-- 조건을 통한 식당 검색 -->
	<select id="condition_search_list" parameterType="HashMap" resultType="dev.mvc.restaurant.RestaurantVO">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano
		FROM restaurant
		WHERE restno IN (
			SELECT restno
    		FROM admitperson
    		WHERE reserve_date = TO_DATE(#{date}, 'YYYY-MM-DD')
    		AND time = #{time}
    		AND admit_person >= curr_person + #{person}
		<if test="categoryno != null">
			AND categoryno = #{categoryno}
		</if>
		<if test="botareanos.length > 0">
			AND botareano IN
			<foreach item="item" index="index" collection="botareanos" open="(" separator="," close=")">
            	#{item}
        	</foreach>
		</if>
		AND restno IN (
		    SELECT restno 
		    FROM menu
		    WHERE price BETWEEN #{min_price} * 10000 AND #{max_price} * 10000)
	</select>
	
	<!-- 좌표값을 통한 식당 검색 -->
	<select id="coordinate_search_list" parameterType="HashMap" resultType="dev.mvc.restaurant.RestaurantVO">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano 
		FROM restaurant
		WHERE lat BETWEEN #{max_lat} AND #{min_lat}
		AND lng BETWEEN #{max_lng} AND #{min_lng}
	</select>
	
</mapper>