<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.mvc.restaurant.RestaurantDAOInter">
    <select id="checkID" resultType="int" parameterType="String">
        SELECT COUNT(id) as cnt
        FROM owner
        WHERE id=#{id}
    </select>



	<!-- 기존 create-->
    <insert id="create" parameterType="dev.mvc.restaurant.RestaurantVO">
        INSERT INTO restaurant(restno, name, tel, ownerno, categoryno)
        VALUES (restaurant_seq.nextval, #{name},#{tel}, #{ownerno}, #{categoryno})
    </insert>
    
	
    <select id="nextval" resultType="int">
        SELECT restaurant_seq.currval AS restno FROM dual
    </select>
	
	
    <select id="list_search_paging" parameterType="java.util.Map" resultType="dev.mvc.dto.RestDTO">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT distinct restno, name, tel, ownerno, categoryno,  image1, image2, image3 FROM (
                SELECT distinct s.restno, s.name, s.tel, s.ownerno, s.categoryno, img1.thumbfile AS image1, img2.thumbfile AS image2, img3.thumbfile AS image3, ROWNUM as r
                FROM (
                    SELECT restno, name, tel, ownerno, categoryno
                    FROM restaurant
                ) s
                LEFT JOIN restimage img1 ON s.restno = img1.restno AND rownum = 1
                LEFT JOIN restimage img2 ON s.restno = img2.restno AND rownum = 1
                LEFT JOIN restimage img3 ON s.restno = img3.restno AND rownum = 1
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                <![CDATA[
            SELECT distinct restno, name, tel, ownerno, categoryno,  image1, image2, image3 FROM (
                SELECT distinct s.restno, s.name, s.tel, s.ownerno, s.categoryno, img1.thumbfile AS image1, img2.thumbfile AS image2, img3.thumbfile AS image3, ROWNUM as r
                FROM (
                    SELECT restno, name, tel, ownerno, categoryno
                    FROM restaurant
                    WHERE name LIKE '%' || #{word} || '%'
                ) s
                LEFT JOIN restimage img1 ON s.restno = img1.restno
                LEFT JOIN restimage img2 ON s.restno = img2.restno
                LEFT JOIN restimage img3 ON s.restno = img3.restno
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT distinct restno, name, tel, ownerno, categoryno,  image1, image2, image3 FROM (
                SELECT  distinct s.restno, s.name, s.tel, s.ownerno, s.categoryno, img1.thumbfile AS image1, img2.thumbfile AS image2, img3.thumbfile AS image3, ROWNUM as r
                FROM (
                    SELECT restno, name, tel, ownerno, categoryno
                    FROM restaurant
                ) s
                LEFT JOIN restimage img1 ON s.restno = img1.restno
                LEFT JOIN restimage img2 ON s.restno = img2.restno
                LEFT JOIN restimage img3 ON s.restno = img3.restno
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                <![CDATA[
            SELECT distinct restno, name, tel, ownerno, categoryno,  image1, image2, image3 FROM (
                SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno, img1.thumbfile AS image1, img2.thumbfile AS image2, img3.thumbfile AS image3, ROWNUM as r
                FROM (
                    SELECT restno, name, tel, ownerno, categoryno
                    FROM restaurant
                    WHERE ownerno LIKE '%' || #{word} || '%'
                ) s
                LEFT JOIN restimage img1 ON s.restno = img1.restno
                LEFT JOIN restimage img2 ON s.restno = img2.restno
                LEFT JOIN restimage img3 ON s.restno = img3.restno
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
    </select>



    <select id="findByOwnerR" parameterType="int" resultType="dev.mvc.restaurant.RestaurantVO">

     SELECT *
     FROM restaurant WHERE ownerno = #{ownerno}


    </select>

    <select id="list_search_count" parameterType="java.util.Map" resultType="int">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE name LIKE '%' || #{word} || '%'
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE ownerno LIKE '%' || #{word} || '%'
            </if>
        </if>
    </select>
	<select id="list_all">
		SELECT *
     	FROM restaurant 
	</select>
	
	<!-- 변경 예정 create-->
	<!--
	<insert id="create" parameterType="dev.mvc.restaurant.RestaurantVO">
        INSERT INTO restaurant(restno, name, tel, grade, address, lat, lng, reserveRange, ownerno, categoryno, botareano)
        VALUES (restaurant_seq.nextval, #{name},#{tel}, #{ownerno}, #{categoryno})
    </insert>
	-->
	
	<!-- 식당 조회 -->
	<select id="read" parameterType="int" resultType="dev.mvc.restaurant.RestaurantVO">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano
		FROM restaurant
		WHERE restno = #{restno}
	</select>
	
	<!-- 조건을 통한 식당 검색 -->
	<select id="condition_search_list">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano
		FROM restaurant
		WHERE restno IN (SELECT restno
							FROM admitperson
							WHERE time = #{time}
							AND admit_person >= curr_person + #{person})
		<if test="categoryno != null">
			AND categoryno = #{categoryno}
		</if>
		<if test="botareanos.length > 0">
			AND botareano IN
			<foreach item="item" index="index" collection="botareanos" open="(" separator="," close=")">
            	#{item}
        	</foreach>
		</if>
		AND price BETWEEN #{min_price} * 10000 AND #{max_price} * 10000
	</select>
	
	<!-- 좌표값을 통한 식당 검색 -->
	<select id="coordinate_search_list">
		SELECT restno, name, tel, grade, address, lat, lng, reserve_range, ownerno, categoryno, botareano 
		FROM restaurant
		WHERE lat BETWEEN #{max_lat} AND #{min_lat}
		AND lng BETWEEN #{max_lng} AND #{mint_lng}
	</select>
	
	<
</mapper>