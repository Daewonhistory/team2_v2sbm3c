<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.mvc.restaurant.RestaurantDAOInter">
    <select id="checkID" resultType="int" parameterType="String">
        SELECT COUNT(id) as cnt
        FROM owner
        WHERE id=#{id}
    </select>




    <insert id="create" parameterType="dev.mvc.restaurant.RestaurantVO">
        INSERT INTO restaurant(restno, name, tel,ownerno,categoryno)
        VALUES (restaurant_seq.nextval, #{name},#{tel}, #{ownerno}, #{categoryno})
    </insert>



    <select id="nextval" resultType="int">
        SELECT restaurant_seq.nextval AS restno FROM dual
    </select>

	
    <select id="list_search_paging" parameterType="java.util.Map" resultType="dev.mvc.restaurant.RestaurantVO">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    WHERE s.name LIKE '%' || #{word} || '%'
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                <![CDATA[
            SELECT * FROM (
                SELECT restno, name, tel, ownerno, categoryno, image1, image2, image3, ROWNUM as r
                FROM (
                    SELECT s.restno, s.name, s.tel, s.ownerno, s.categoryno,
                           MAX(CASE WHEN img.rn = 1 THEN img.thumbfile ELSE NULL END) AS image1,
                           MAX(CASE WHEN img.rn = 2 THEN img.thumbfile ELSE NULL END) AS image2,
                           MAX(CASE WHEN img.rn = 3 THEN img.thumbfile ELSE NULL END) AS image3
                    FROM restaurant s
                    LEFT JOIN (
                        SELECT restno, thumbfile, ROW_NUMBER() OVER (PARTITION BY restno ORDER BY thumbfile) as rn
                        FROM restimage
                    ) img ON s.restno = img.restno
                    WHERE s.ownerno LIKE '%' || #{word} || '%'
                    GROUP BY s.restno, s.name, s.tel, s.ownerno, s.categoryno
                )
                WHERE ROWNUM <= #{end_num}
            ) WHERE r >= #{start_num}
            ]]>
            </if>
        </if>
    </select>


    <select id="findByOwnerR" parameterType="int" resultType="dev.mvc.restaurant.RestaurantVO">

     SELECT *
     FROM restaurant WHERE ownerno = #{ownerno}


    </select>

    <select id="list_search_count" parameterType="java.util.Map" resultType="int">
        <if test="type == 100">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- name으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE name LIKE '%' || #{word} || '%'
            </if>
        </if>
        <if test="type == 200">
            <if test="word == null or word == ''">
                <!-- 전체 결과를 가져오는 쿼리 -->
                SELECT count(*) as cnt
                FROM restaurant
            </if>
            <if test="word != null and word != ''">
                <!-- ownerno으로 조회 -->
                SELECT count(*) as cnt
                FROM restaurant
                WHERE ownerno LIKE '%' || #{word} || '%'
            </if>
        </if>
    </select>
	<select id="list_all">
		SELECT *
     	FROM restaurant 
	</select>


</mapper>