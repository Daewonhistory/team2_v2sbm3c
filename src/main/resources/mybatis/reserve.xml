<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.mvc.reserve.ReserveDAOInter">
    <!-- 예약 등록 -->
    <insert id="create" parameterType="dev.mvc.reserve.ReserveVO">
        INSERT INTO reserve (reserveno, sub_date, person, custno, admitpersonno)
        VALUES (reserve_seq.nextval, sysdate, #{person}, #{custno}, #{admitpersonno})
    </insert>

    <!-- 모든 예약 조회 -->
    <select id="list_all" resultType="dev.mvc.reserve.ReserveVO">
        SELECT reserveno, sub_date, person, custno, admitpersonno
        FROM reserve
    </select>

    <!-- 특정 reserve_date의 예약 조회 -->
    <select id="list_search_by_reserve_date" parameterType="map" resultType="dev.mvc.reserve.ReserveVO">
        SELECT reserveno, sub_date, person, custno, admitpersonno
        FROM reserve
        WHERE custno = #{custno}
        AND admitpersonno IN (
            SELECT admitpersonno
            FROM admitperson
            WHERE reserve_date = TO_DATE(#{reserveDate}, 'YYYY-MM-DD')
        )
    </select>
    
    <!-- 특정 식당의 예약 수 조회 -->
    <select id="count_by_restno" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM reserve r
        JOIN admitperson a ON r.admitpersonno = a.admitpersonno
        WHERE a.restno = #{restno}
    </select>
    
    <!-- 로그인한 사람의 예약 조회 -->
    <select id="list_search_by_custno" parameterType="int" resultType="dev.mvc.reserve.ReserveVO">
        SELECT reserveno, sub_date, person, custno, admitpersonno
        FROM reserve
        WHERE custno = #{custno}
    </select>
   
    <!-- 예약 취소 -->
    <delete id="delete" parameterType="int">
        DELETE FROM reserve 
        WHERE reserveno = #{reserveno}
    </delete>
   
    <!-- 페이징을 적용한 예약 조회 -->
    <select id="list_reserve_paging" parameterType="map" resultType="dev.mvc.dto.ReserveDTO">
    <![CDATA[
        SELECT * FROM (
            SELECT ROWNUM AS rnum, r.reserveno, TO_CHAR(r.sub_date, 'YYYY-MM-DD') as sub_date, r.person, c.nickname, rest.name as restname
            FROM reserve r
            JOIN customer c ON r.custno = c.custno
            JOIN admitperson a ON r.admitpersonno = a.admitpersonno
            JOIN restaurant rest ON a.restno = rest.restno
            WHERE ROWNUM <= #{end_num}
            <if test="reserve_date != null and reserve_date != ''">
                AND TO_CHAR(r.sub_date, 'YYYY-MM-DD') = #{reserve_date}
            </if>
            <if test="restno != 0">
                AND rest.restno = #{restno}
            </if>
            ORDER BY r.reserveno DESC
        )
        WHERE rnum >= #{start_num}
    ]]>
    </select>
    
    <!-- 특정 사업자의 예약 수 조회 -->
    <select id="count_by_owner" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM reserve r
        JOIN admitperson a ON r.admitpersonno = a.admitpersonno
        JOIN restaurant rest ON a.restno = rest.restno
        WHERE rest.ownerno = #{ownerno}
    </select>

    <!-- 예약 목록 조회 (사업자별, 페이징, 날짜 및 식당 필터 포함) -->
    <select id="list_owner_page" parameterType="map" resultType="dev.mvc.dto.ReserveDTO">
    <![CDATA[
        SELECT * FROM (
            SELECT ROWNUM AS rnum, r.reserveno, TO_CHAR(r.sub_date, 'YYYY-MM-DD') as sub_date, r.person, c.nickname, rest.name as restname
            FROM reserve r
            JOIN customer c ON r.custno = c.custno
            JOIN admitperson a ON r.admitpersonno = a.admitpersonno
            JOIN restaurant rest ON a.restno = rest.restno
            WHERE rest.ownerno = #{ownerno}
            <if test="reserve_date != null and reserve_date != ''">
                AND TO_CHAR(r.sub_date, 'YYYY-MM-DD') = #{reserve_date}
            </if>
            <if test="restno != 0">
                AND rest.restno = #{restno}
            </if>
            ORDER BY r.reserveno DESC
        )
        WHERE rnum &gt;= #{start_num} AND rnum &lt;= #{end_num}
    ]]>
    </select>

    <!-- 전체 예약 수 조회 -->
    <select id="count_all" resultType="int">
        SELECT COUNT(*) FROM reserve
    </select>
    
</mapper>
