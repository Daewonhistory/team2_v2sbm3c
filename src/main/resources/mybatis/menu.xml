<?xml version="1.0" encoding="UTF-8"?>
 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.mvc.menu.MenuDAOInter"> <!-- SB가 자동으로 구현하여 연동하는 interface -->
  <insert id="create" parameterType="dev.mvc.ingredient.IngredientVO"> <!-- public int create(CateVO cateVO) {...-->
  	INSERT INTO MENU(menuno, name, price, restno, image)
	VALUES (menu_seq.nextval, #{name}, #{price}, #{restno}, #{image})
  </insert>
  
  <select id="read" resultType="dev.mvc.menu.MenuVO">
    SELECT menuno, name, price, restno, image
	FROM menu
	WHERE menuno = #{menuno}
  </select>
  
  <delete id="delete_by_menuno" parameterType="int">
  	DELETE FROM menu
	WHERE menuno = #{menuno}
  </delete>
  
  <update id="update_by_menuno" parameterType="dev.mvc.menu.MenuVO">
  	UPDATE menu
	SET name = #{name}
	WHERE menuno = #{menuno}
  </update>
  
  <select id="list_by_restno">
  	SELECT menuno, name, price, restno, image
  	FROM menu
  	WHERE restno = #{restno}
  </select>
  <!-- 카테고리별 검색 + 페이징 목록 -->
  <select id="list_search_paging" resultType="dev.mvc.menu.MenuVO" parameterType="HashMap">
    SELECT menuno, name, price, restno, image, restname, r
	  FROM (
        SELECT menuno, name, price, restno, image, restname, rownum as r
        FROM (
          SELECT  menuno, menu.name as name, price, menu.restno as restno, image, rest.name as restname
          FROM menu 
          INNER JOIN restaurant rest
          ON menu.restno = rest.restno
          <if test="restno != 0">
          AND rest.restno = #{restno}
          </if>
          <if test="word != null and word != ''">
          WHERE UPPER(menu.name) LIKE '%' || UPPER(#{word}) || '%'
          </if>
          ORDER BY menuno DESC
      )
	)
    WHERE <![CDATA[ r >= #{start_num} AND r <= #{end_num} ]]>
     
    <!-- 1 page: WHERE r >= 1 AND r <= 10; 
          2 page: WHERE r >= 11 AND r <= 20;
          3 page: WHERE r >= 21 AND r <= 30; -->
  </select>
  
  <!-- 카테고리별 검색 레코드 갯수 -->
  <select id="list_search_count" resultType="int" parameterType="HashMap">
    SELECT COUNT(*) as cnt
    FROM menu
    <choose>
      <when test="word == null or word == ''"> <!-- 검색하지 않는 경우의 레코드 갯수 -->
      </when>
      <otherwise> <!-- 검색하는 경우의 레코드 갯수 -->
        WHERE UPPER(name) LIKE '%' || UPPER(#{word}) || '%'
        
      </otherwise>
    </choose>
  </select>  
  
  <select id="list_by_restno_search_count" resultType="int" parameterType="HashMap">
    SELECT COUNT(*) as cnt
    FROM menu
    <choose>
    <when test="restno != 0">
    	 WHERE restno = #{restno}
    	 <if test="word != null and word != ''"> <!-- 검색하지 않는 경우의 레코드 갯수 -->
      		AND UPPER(name) LIKE '%' || UPPER(#{word}) || '%'
  		</if>
    </when>
    <otherwise>
    	<if test="word != null and word != ''"> <!-- 검색하지 않는 경우의 레코드 갯수 -->
      		WHERE UPPER(name) LIKE '%' || UPPER(#{word}) || '%'
  		</if>
    </otherwise>
    </choose>
  	
    
  </select>    
  
  <select id="list_by_restno_count" resultType="int" parameterType="int">
  	SELECT COUNT(*)
	FROM menu
	WHERE restno = #{restno}
  </select>
  
  <select id="last_menu_by_restno" resultType="dev.mvc.menu.MenuVO" parameterType="int">
  	SELECT menuno, name, price, restno, image
	FROM(
	    SELECT menuno, name, price, restno, image, ROWNUM
	    FROM menu
	    WHERE restno = #{restno}
	    ORDER BY ROWNUM DESC)
	WHERE ROWNUM = 1
  </select>
  	
</mapper>