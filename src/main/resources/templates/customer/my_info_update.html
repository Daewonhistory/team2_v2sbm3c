<!DOCTYPE html>

<html layout:decorate="~{mobile_layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">
  <script>
    
 
// 재료 입력 필드를 제거하는 함수
function removeIngredient(button) {
  const ingredientDiv = button.parentElement;
  document.getElementById('ingredients').removeChild(ingredientDiv);
}

// 재료를 추가하는 함수
function addIngredient(ingredno, name) {
  // 중복 확인
  const existingIngredients = document.querySelectorAll('#ingredients input[name="ingredno[]"]');
  for (let i = 0; i < existingIngredients.length; i++) {
    if (existingIngredients[i].value == ingredno) {
      // 중복되는 경우 추가하지 않고 함수 종료
      return;
    }
  }

  const ingredientDiv = document.createElement('div');
  ingredientDiv.classList.add('ingredient');
  ingredientDiv.style = "background-color: gray; border-radius: 20px; width: 150px; display: flex; justify-content: space-between; align-items: center; padding: 5px; margin: 5px;";

  const ingredientInput = document.createElement('input');
  ingredientInput.type = 'hidden';
  ingredientInput.name = 'ingredno[]';
  ingredientInput.value = ingredno;
  ingredientInput.required = true;

  const ingredientText = document.createElement('span');
  ingredientText.innerText = name;

  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.innerText = '삭제';
  removeButton.style = "margin-left: 10px; background-color: red; color: white; border: none; border-radius: 5px; padding: 2px 5px;";

  removeButton.onclick = function() {
    removeIngredient(removeButton);
  };

  ingredientDiv.appendChild(ingredientInput);
  ingredientDiv.appendChild(ingredientText);
  ingredientDiv.appendChild(removeButton);

  document.getElementById('ingredients').appendChild(ingredientDiv);
}

// 알러지 재료를 선택하여 추가하는 함수
function handleSelectChange(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  if (selectedOption.value !== "") {
    addIngredient(selectedOption.value, selectedOption.text);
  }
}
    window.onload = function () {
      document.querySelector('#id').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('btn_checkID').focus();
        }
      });




      document.querySelector('#cname').addEventListener('keypress', (event) => {
        let cname = document.getElementById('cname').value.trim();
        if (cname !== "" && event.key === 'Enter') {
          document.getElementById('phone').focus();
        } else if (cname === "" && event.key === 'Enter') {
          document.getElementById('cname').focus();
        }
      });

      document.querySelector('#phone').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('btn_DaumPostcode').focus();
        }
      });

      document.querySelector('#address2').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('btn_send').focus();
        }
      });


    }

    function checknickname() {
      let nickname = document.getElementById('nickname');
      let nickname_msg = document.getElementById('nickname_msg');

      if (nickname.value.trim().length == 0) {
        nickname_msg.style.fontSize = "12px";
        nickname_msg.innerHTML = '닉네임이 누락되었습니다. 닉네임 입력은 필수 입니다.';
        nickname_msg.style.marginTop = "5px";
        nickname_msg.classList.add('span_warning');    // class 적용
        nickname.focus();

        return false;  // 회원 가입 진행 중지

      }
      if (nickname.value.trim().length < 3) {
        nickname_msg.innerHTML = ' 닉네임은는 2자이상 권장합니다.';
        nickname_msg.style.marginTop = "5px";
        nickname_msg.classList.add('span_warning');    // class 적용
        nickname.focus();

        return false;  // 회원 가입 진행 중지
      } else {  // when ID is entered
        nickname_msg.classList.remove('span_warning'); // class 삭제

        let nickname = document.getElementById('nickname');

        let url = './checkNickName?nickname=' + nickname.value;

        fetch(url, {
          method: 'POST'
        })
            .then(response => response.json())
            .then(rdata => {
              if (rdata.cnt > 0) { // 아이디 중복
                nickname_msg.innerHTML = '이미 사용중인 닉네임 입니다. 다른 닉네임을 지정해주세요.';
                nickname_msg.classList.add('span_warning2');
                nickname.focus();

              } else { // 아이디 중복 안됨.
                nickname_msg.style.marginTop = "5px";
                nickname_msg.innerHTML = '사용 가능한 닉네임 입니다.';
                nickname_msg.classList.add('span_info2');
                document.getElementById('address1').focus();
              }
            })
            .catch(error => { // 서버 다운등 통신 에러
              console.error('Error:', error);
            });

        // 처리중 출력
        nickname_msg.innerHTML = "<img src='/images/progress.gif' style='width: 5%;'>"; // static 기준

      }
    }


    function checkID() {
      let id = document.getElementById('id');
      let id_msg = document.getElementById('id_msg');

      if (id.value.trim().length == 0) {
        id_msg.style.fontSize = "12px";
        id_msg.innerHTML = 'ID가 누락되었습니다. ID 입력은 필수 입니다.';
        id_msg.style.marginTop = "5px";
        id_msg.classList.add('span_warning');    // class 적용
        id.focus();

        return false;  // 회원 가입 진행 중지

      }
      if (id.value.trim().length < 4) {
        id_msg.innerHTML = ' ID(이메일)는 3자이상 권장합니다.';
        id_msg.style.marginTop = "5px";
        id_msg.classList.add('span_warning');    // class 적용
        id.focus();

        return false;  // 회원 가입 진행 중지
      } else {  // when ID is entered
        id_msg.classList.remove('span_warning'); // class 삭제

        let id = document.getElementById('id');
        let url = './checkID?id=' + id.value;

        fetch(url, {
          method: 'POST'
        })
            .then(response => response.json())
            .then(rdata => {
              if (rdata.cnt > 0) { // 아이디 중복
                id_msg.innerHTML = '이미 사용중인 ID(이메일) 입니다. 다른 ID(이메일)을 지정해주세요.';
                id_msg.classList.add('span_warning');
                id.focus();
                setTimeout(function () {
                  id_msg.innerHTML = '';
                }, 5000); // 5초 후에 내용을 지움


              } else { // 아이디 중복 안됨.
                id_msg.style.marginTop = "5px";
                id_msg.innerHTML = '사용 가능한 ID(이메일) 입니다.';
                id_msg.classList.add('span_info');
                document.getElementById('passwd').focus();
              }
            })
            .catch(error => { // 서버 다운등 통신 에러
              console.error('Error:', error);
            });

        // 처리중 출력
        id_msg.innerHTML = "<img src='/images/progress.gif' style='width: 5%;'>"; // static 기준

      }
    }

    function send() { // 회원 가입 처리
      let id = document.getElementById('id');
      let id_msg = document.getElementById('id_msg');


      let cname = document.getElementById('cname');
      let cname_msg = document.getElementById('cname_msg');


      let nickname = document.getElementById('nickname');
      let nickname_msg = document.getElementById('nickname_msg');
      let address1 = document.getElementById('address1');
      let address1_msg = document.getElementById('address1_msg');
      let address2 = document.getElementById('address2');
      let address2_msg = document.getElementById('address2_msg');

      let phone1 = document.getElementById('phone1').value;
      let phone2 = document.getElementById('phone2').value;
      let phone3 = document.getElementById('phone3').value;

      let phone = phone1 + phone2 + phone3; // 두 번째와 세 번째 번호를 합침



      if (id.value.trim().length == 0) {
        id_msg.style.fontSize = "12px";
        id_msg.innerHTML = 'ID가 누락되었습니다. ID 입력은 필수 입니다.';
        id_msg.classList.add('span_warning');    // class 적용
        id.focus();

        return false;  // 회원 가입 진행 중지

      }
      if (id.value.trim().length < 4) {
        id_msg.innerHTML = ' ID(이메일)는 3자이상 권장합니다.';
        id_msg.style.marginTop = "5px";
        id_msg.classList.add('span_warning');    // class 적용
        id.focus();

        return false;  // 회원 가입 진행 중지
      }

      if (cname.value.trim().length == 0) {
        cname_msg.style.fontSize = "12px";
        cname_msg.innerHTML = '이름이 누락되었습니다. 이름 입력은 필수 입니다.';
        cname_msg.classList.add('span_warning');    // class 적용
        cname.focus();

        return false;  // 회원 가입 진행 중지

      }




      // 패스워드를 정상적으로 2번 입력했는지 확인







      // let gender = document.getElementById('gender');
      // let gender_msg = document.getElementById('gender_msg');
      //
      // if (gender.value == "") {
      //   gender_msg.innerHTML = '성별을 선택해주세요.';
      //   gender_msg.classList.add('span_warning');    // class 적용
      //   gender.focus();
      //
      //   return false;  // 회원 가입 진행 중지
      // }

      if (phone2.trim().length == 0 || phone3.trim().length == 0 || phone2.length < 4 || phone3.length < 4) {
        alert('전화번호 두 번째와 세 번째 자리는 공백 없이 4자리 이상이어야 합니다.');
        return false;
      }

      // 폼에 전화번호 값 설정
      document.getElementById('phone').value = phone;


      if (address1.value.length == 0) {
        address1_msg.innerHTML = '주소 입력은 필수입니다.';
        address1_msg.classList.add('span_warning');    // class 적용
        address1.focus();

        return false;  // 회원 가입 진행 중지
      }

      if (address2.value.length == 0) {
        address2_msg.innerHTML = '상세주소 입력은 필수입니다.';
        address2_msg.classList.add('span_warning');    // class 적용
        address2.focus();

        return false;  // 회원 가입 진행 중지
      }
      document.getElementById('phone').value = phone;

      document.getElementById('login-form').submit(); // required="required" 작동 안됨


      // .
    }
  </script>
  <div class="login-wrapper" th:object="${customerVO}">
    <h2 th:text="|${customerVO.cname} 정보 수정|"> </h2>
    <form method="post" action="/customer/update-mypage"  id="login-form">
      <label>아이디</label>
      <input type="text" name="id" placeholder="아이디" id="id" th:value="${customerVO.id}" autofocus="autofocus"
            readonly style="margin-top: 10px">
      <label>이름</label>
      <input type='text' name='cname' th:value="${customerVO.cname}" id='cname' value='' required="required"
             placeholder="성명" style="margin-top: 10px">
      <span id='cname_msg'></span>
      <label style="margin-top:5px;">전화 번호 <span class="required">*</span> </label>
      <div style="margin-top: 10px;">
        <input type='text' id='phone1'   th:value="${customerVO.phone.substring(0,3)}" placeholder="" style="width: 25%;">
        <span style="margin-left: 3px; margin-right: 3px; font-weight: bold">-</span>
        <input type='text' id='phone2'  th:value="${customerVO.phone.substring(3,7)}" style="width: 25%;">
        <span style="margin-left: 3px; margin-right: 3px; font-weight: bold">-</span>
        <input type='text' id='phone3'   th:value="${customerVO.phone.substring(7,11)}" placeholder="0000"
               style="width: 25%;">
      </div>
      <input type="hidden" name="phone" id="phone" value="">
      <label>
        우편번호
      </label>
      <div>
        <input type='text' name='zipcode' id='zipcode'  th:value="${customerVO.zipcode}"style="width: 32%;" value=''
               placeholder="우편번호" readonly>

        <button type='button'id="btn_DaumPostcode" onclick="DaumPostcode()"
                style="margin-left: 10px; margin-top: 10px; width: 32%;" >우편번호찾기
        </button>
        <!-- ------------------------------ DAUM 우편번호 API 시작 ------------------------------ -->
        <div>
          <div id="wrap" style="display:none;border:1px solid;width:450px;height:300px;margin:5px 0;position:relative">
            <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnFoldWrap"
                 style="cursor:pointer;position:absolute;right:0px;top:-1px;z-index:1" onclick="foldDaumPostcode()"
                 alt="접기 버튼">
          </div>
        </div>

        <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
        <script>
          // 우편번호 찾기 찾기 화면을 넣을 element
          var element_wrap = document.getElementById('wrap');

          function foldDaumPostcode() {
            // iframe을 넣은 element를 안보이게 한다.
            element_wrap.style.display = 'none';
          }

          function DaumPostcode() {
            // 현재 scroll 위치를 저장해놓는다.
            var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
            new daum.Postcode({
              oncomplete: function (data) {
                // 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                  addr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우(J)
                  addr = data.jibunAddress;
                }

                /*
                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if(data.userSelectedType === 'R'){
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("sample3_extraAddress").value = extraAddr;

                } else {
                    document.getElementById("sample3_extraAddress").value = '';
                }
                */

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById('zipcode').value = data.zonecode; // 우편번호
                document.getElementById("address1").value = addr;  // 주소

                document.getElementById("address2").innerHTML = ""; // 상세 주소 지우기
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById("address2").focus();  // 상세 주소로 포커스 이동

                // iframe을 넣은 element를 안보이게 한다.
                // (autoClose:false 기능을 이용한다면, 아래 코드를 제거해야 화면에서 사라지지 않는다.)
                element_wrap.style.display = 'none';

                // 우편번호 찾기 화면이 보이기 이전으로 scroll 위치를 되돌린다.
                document.body.scrollTop = currentScroll;
              },
              // 우편번호 찾기 화면 크기가 조정되었을때 실행할 코드를 작성하는 부분. iframe을 넣은 element의 높이값을 조정한다.
              onresize: function (size) {
                element_wrap.style.height = size.height + 'px';
              },
              width: '100%',
              height: '100%'
            }).embed(element_wrap);

            // iframe을 넣은 element를 보이게 한다.
            element_wrap.style.display = 'block';
          }
        </script>
      </div>

      <div>
        <label>주소</label>
        <input style="margin-top: 10px" type='text' name='address1' th:value="${customerVO.address1}" id='address1'
               value=''
               placeholder="주소1"
               readonly>
        <label>상세주소</label>
        <input type='text' style="margin-top: 10px" name='address2' th:value="${customerVO.address2}" id='address2'
               value=''
               placeholder="주소2"
        >
      </div>
      
      <div class="form-group" style="margin-top: 10px;">
        <label>알러지 재료:</label>
        <select id="ingredientSelect" onchange="handleSelectChange(this)" class="form-control form-control-sm" style="width: 70%;">
          <option value="">재료 선택</option>
          <option th:each="ingredient : ${ingredient_list}" th:value="${ingredient.ingredno}" th:text="${ingredient.name}"></option>
        </select>
        <input type="hidden" name="custno" th:value="${customerVO.custno}">
      </div>

      <div id="ingredients" class="form-group" style="margin-top: 10px;">
        <div th:each="allergy : ${allergies}" class="ingredient" style="background-color: gray; border-radius: 20px; width: 150px; display: flex; justify-content: space-between; align-items: center; padding: 5px; margin: 5px;">
          <input type="hidden" name="ingredno[]" th:value="${allergy.ingredno}">
          <span th:text="${allergy.ingredientName}" style="color: white;"></span>
          <button type="button" onclick="removeIngredient(this)" style="margin-left: 10px; background-color: red; color: white; border: none; border-radius: 5px; padding: 2px 5px;">삭제</button>
        </div>
      </div>





      <button type="button"  onclick="return send()" id="btn_send">정보 수정</button>
      <button type="button" style="margin: 0px;" onclick="location.href = '/customer/my_page';" id="btn_cancel">이전 화면</button>

    </form>
  </div>
</div>

