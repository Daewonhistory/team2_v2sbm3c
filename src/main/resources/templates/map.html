<!DOCTYPE html>
<html layout:decorate="~{mobile_layout}">

<div layout:fragment="content" id="fragment-container">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6b1da0a4ed6afcc9cf9d6743c38f8aa6"></script>
  <div id="map-section">
  	<div id="map"></div>
  </div>
  <button type="button" onclick="coordinateSearchList()">현재 지도에서 식당찾기</button>
  <div id="rest-container">
  	<div id="rest-list-container">
  	</div>
  </div>
	<script>
	window.onload = () => {
		if (navigator.geolocation) {
	
			// GeoLocation을 이용해서 접속 위치를 얻어옵니다
			navigator.geolocation.getCurrentPosition(function(position) {
				
				currentLat = position.coords.latitude; // 위도
				currentLng = position.coords.longitude; // 경도
				map.setCenter(new kakao.maps.LatLng(currentLat, currentLng));
			});
		} else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
			currentLat = 37.9699349; // 위도
			currentLng = 127.3260396; // 경도
			map.setCenter(new kakao.maps.LatLng(currentLat, currentLng));
		}
	}
	let currentLat;
	let currentLng;
	
	const container = document.getElementById('map');
	let options = {
		center: new kakao.maps.LatLng(37.9699349, 127.3260396),
		level: 3
	};
	
	let map = new kakao.maps.Map(container, options);
	
	var geocoder = new kakao.maps.services.Geocoder();

// 주소로 좌표를 검색합니다
geocoder.addressSearch('제주특별자치도 제주시 첨단로 242', function(result, status) {

    // 정상적으로 검색이 완료됐으면 
     if (status === kakao.maps.services.Status.OK) {
		console.log(result[0].y, result[0].x)
        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

        // 결과값으로 받은 위치를 마커로 표시합니다
        var marker = new kakao.maps.Marker({
            map: map,
            position: coords
        });

        // 인포윈도우로 장소에 대한 설명을 표시합니다
        var infowindow = new kakao.maps.InfoWindow({
            content: '<div style="width:150px;text-align:center;padding:6px 0;">우리회사</div>'
        });
        infowindow.open(map, marker);

        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
        map.setCenter(coords);
    } 
});    
	let markers = [];
	let openInfoWindow;
	
	
	
	// 배열에 추가된 마커들을 지도에 표시하거나 삭제하는 함수입니다
	function setMarkers(map) {
		for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
    }     
       
	}	
	
	function closeInfoWindows(){
		for(let infoWindow in openInfoWindows){
			infoWindow.close();
		}
	}
	
	// 마커를 생성하고 지도위에 표시하는 함수입니다
	function addMarker(position, restaurantVO) {
	    
	    // 마커를 생성합니다
	    var marker = new kakao.maps.Marker({
	        position: position
	    });
	    
	    let url = `/restaurant/main_page?restno=${restaurantVO.restno}&persno=2&date=2024-06-17`;
	    let src = `/restaurant/storage/${restaurantVO.image1}`;
			// 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성합니다
			let iwContent = `
			<div style="padding:5px;width:max-content;height:max-content;">
				<a href="${url}">${restaurantVO.name}</a>
				<img src="${src}" style="width:50px; height:50px">
			</div>` // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다''
			let iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
			
			var infowindow = new kakao.maps.InfoWindow({
				content : iwContent,
				removable : iwRemoveable
			});
			
			kakao.maps.event.addListener(marker, 'click', function() {
				if(openInfoWindow != null){
					openInfoWindow.close();
				}
				// 마커 위에 인포윈도우를 표시합니다
				infowindow.open(map, marker);
				openInfoWindow = infowindow;
				
				map.panTo(position); 
			});
			
			
	    // 마커가 지도 위에 표시되도록 설정합니다
	    marker.setMap(map);
	    
	    // 생성된 마커를 배열에 추가합니다
	    markers.push(marker);
	}
	function moveRestaurant(event){
		let inputs = event.currentTarget.querySelector('input');
		let restno = inputs.value;
		location.href = "/restaurant/main_page?restno=" + restno + "&person=2&date=2024-06-21";
	}
	function coordinateSearchList(){
		console.log("1111");
		// 지도의 현재 영역을 얻어옵니다 
    let bounds = map.getBounds();
		// 영역의 남서쪽 좌표를 얻어옵니다 
    let swLatLng = bounds.getSouthWest(); 
    
    // 영역의 북동쪽 좌표를 얻어옵니다 
    let neLatLng = bounds.getNorthEast();
    
    fetch(
	          "/restaurant/coordinate_search_list",
	          {
	            method: "POST",
	            headers: {"Content-Type": "application/json"},
	            body: JSON.stringify({
																		"westLat": swLatLng.getLat(),
																		"eastLat": neLatLng.getLat(),
																		"southLng": swLatLng.getLng(),
																		"northLng": neLatLng.getLng()
																		})
	          }
	        )
          .then((response) => response.json())
          .then((rdata) => {
					  const sectionList = document.getElementById('rest-list-container');
					  sectionList.innerHTML = '';
						setMarkers(null);
						markers = [];
				  	rdata.forEach(restaurantVO => {
						 
						  // 마커가 표시될 위치입니다 
							let markerPosition  = new kakao.maps.LatLng(restaurantVO.lat, restaurantVO.lng); 
							
							// 마커를 생성합니다
							let marker = new kakao.maps.Marker({
							    position: markerPosition,
							    clickable: true // 마커를 클릭했을 때 지도의 클릭 이벤트가 발생하지 않도록 설정합니다
							});
							
							// 마커가 지도 위에 표시되도록 설정합니다
							addMarker(markerPosition, restaurantVO);
							
							
							const restaurantInfoDiv = document.createElement('div');
							restaurantInfoDiv.classList.add('restaurant_info');
							restaurantInfoDiv.addEventListener('click', moveRestaurant)
							let src = `/restaurant/storage/${restaurantVO.image1}`;
							restaurantInfoDiv.innerHTML = `
							<input type="hidden" id="restno" value="${restaurantVO.restno}">
							<div style="flex:0 0 20%; height:100%">
								<img src="${src}" style="width:100%; height:100px;background-size:cover;">
							</div>		
							<div style="flex:1; height:100%">
								<div><h2>${restaurantVO.name}</h2></div>
								<div><img src="/images/icon/favorite_actvie.svg" style="width:20px; height:20px;"><span style="font-style:bold;">5.0</span></div>
							</div>`
							sectionList.appendChild(restaurantInfoDiv);
					  });
					  setMarkers(map);
					  
			  	});
	}

	</script>
</div>
</html>