<!DOCTYPE html>
<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">

  <div th:text="${fail}">

  </div>
  <script th:inline="javascript">


    fetch("/category/catelist", {
      method: 'GET'
    })
        .then(response => response.json())
        .then(rdata => {
          const selectElement = document.getElementById('categoryno');

          // 받은 데이터에서 categoryno 값을 옵션으로 추가
          rdata.forEach(item => {
            const option = document.createElement('option');
            option.value = item.categoryno;
            option.text = item.name; // 이 부분을 변경하셔서 원하는 텍스트로 설정하세요.
            selectElement.appendChild(option);
          });
        });

  </script>


  <div class="container">
    <div class="form-container">
      <div class="title_line">식당 등록(<span class="required">*</span>는 필수)</div>
      <form id="frm" name="frm" th:object="${restaurantVO}" enctype="multipart/form-data" method="post"
            action="/restaurant/create">
        <div class="form-group">
          <input type="file" class="form-control" name="file1MF" id="file1MF" placeholder="파일 선택" style="display: none">
          <input type="file" class="form-control" name="file2MF" id="file2MF" placeholder="파일 선택" style="display: none">
          <input type="file" class="form-control" name="file3MF" id="file3MF" placeholder="파일 선택" style="display: none">
          <input type="file" class="form-control" id="rest_imgs" placeholder="파일 선택" style="display: none">
        </div>

        <label>식당 이미지</label>
        <div class="drop-zone" id="drop-zone">
          여기에 사진을 드래그 앤 드롭 하세요 최대 3개 업로드 할 수 있습니다
        </div>
        <div class="preview" id="preview"></div>

        <div class="form-group">
          <label for="name">식당 이름</label>
          <input type="text" class="form-control" name="name" id="name" placeholder="식당 이름">
        </div>
        <div class="form-group">
          <label for="name">예약 범위</label>
          <input type="number" class="form-control" name="reserve_range" id="reserve_range" placeholder="예약 범위">
        </div>
        <div class="form-group">
          <label for="categoryno">식당 카테고리</label>
          <select class="form-control" name="categoryno" id="categoryno">
            <!-- Options should be populated here -->
          </select>
        </div>


        <input type="hidden" class="form-control" name="ownerno" id="ownerno" value="7">
        <div class="form-group">
          <label for="tel">식당 전화번호</label>
          <input type="text" class="form-control" name="tel" id="tel" placeholder="식당 전화번호">
        </div>
        <label for="name" style="margin-top: 10px;">식당 주소</label>
        <div style="display: flex ;">

          <div id="midarea_div" style="width: 25%;">


            <select id="midAreaSelect" name="midAreaSelect" onchange="selectMidArea(this)" class="form-control">
              <option th:each="midAreaVO : ${midAreaList}" th:value="${midAreaVO.midareano}"
                      th:text="${midAreaVO.name}"></option>
            </select>
          </div>

            <div id="botarea_div" style="display:none; width: 25%; ">
          </div>
          <div id="addresshi" style="display:none; width: 50%; margin-left: 10px;  ">
            <input class="form-control" id="addressv" type="text" name="addressv">
            <input  class="form-control" id="alladdress" type="hidden" name="address">
            <input class="form-control" id="lng" type="hidden" name="lng">
            <input class="form-control" id="lat" type="hidden" name="lat">
          </div>
          <div id="findbutton" style="display: none; margin-left: 10px;">
            <button class="btns" type="button" id="searchButton" onclick="searchAddress()" style="margin: 0 auto;">위치 확인</button>
          </div>
        </div>
        <div id="map" style="width:100%;height:350px; display: none; margin-top: 10px; "></div>

        <script src="/js/restaurant/create/SelectMidArea.js"></script>
        <script>
          $(document).ready(function () {
            // Kakao Maps API 초기화
            kakao.maps.load(function () {
              // Select2 초기화
              $('select').select2({
                placeholder: '검색해주세요',
                allowClear: false,
                language: {
                  noResults: function () {
                    return '결과가 없습니다'; // 결과가 없을 때 표시할 메시지
                  }
                }
              });
            });
          })

              // midAreaSelect가 변경될 때 실행되는 함수

        </script>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6b1da0a4ed6afcc9cf9d6743c38f8aa6&libraries=services&autoload=false"></script>

        <script>
          function searchAddress() {
            let maps = document.getElementById('map');
            maps.style.display = "block";
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {

                  center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                  level: 3 // 지도의 확대 레벨
                };

// 지도를 생성합니다
            var map = new kakao.maps.Map(mapContainer, mapOption);

            // 주소-좌표 변환 객체를 생성합니다
            var geocoder = new kakao.maps.services.Geocoder();
            const midarea = document.getElementById("midAreaSelect");
            const midselectedOption = midarea.options[midarea.selectedIndex];
            const midvalue = midselectedOption.text;

            const botarea = document.getElementById("botarea");
            const botareaselectedOption = botarea.options[botarea.selectedIndex];
            const botvalue = botareaselectedOption.text;


            const addressvalue = document.getElementById('addressv').value;

            const allarea = midvalue + " " + botvalue + " " + addressvalue;
            const submitaddress = document.getElementById('alladdress');
            submitaddress.value = allarea;


            console.log(allarea);
            // 주소로 좌표를 검색합니다
            geocoder.addressSearch(allarea, function(result, status) {

              // 정상적으로 검색이 완료됐으면
              if (status === kakao.maps.services.Status.OK) {

                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                // 결과값으로 받은 위치를 마커로 표시합니다
                var marker = new kakao.maps.Marker({
                  map: map,
                  position: coords
                });

                // 인포윈도우로 장소에 대한 설명을 표시합니다
                var infowindow = new kakao.maps.InfoWindow({
                  content: '<div style="width:150px;text-align:center;padding:6px 0;">사업자 식당</div>'
                });
                infowindow.open(map, marker);

                // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                map.setCenter(coords);

                let lat = document.getElementById('lat');
                lat.value = result[0].y;

                let lng = document.getElementById('lng');
                lng.value = result[0].x;

                console.log(coords);
              }
            });
          }

        </script>
        <div class="form-group buttons">
          <button type="submit" class="btn btn-primary" id="btn_send">등록</button>
          <button type="button" class="btn btn-secondary" onclick="back()" id="btn_cancel">취소</button>
        </div>
      </form>
      <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('rest_imgs');
        const preview = document.getElementById('preview');
        const maxFiles = 3;
        let currentFiles = [];

        dropZone.addEventListener('click', () => {
          fileInput.click();
        });

        dropZone.addEventListener('dragover', (event) => {
          event.preventDefault();
          dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (event) => {
          event.preventDefault();
          dropZone.classList.remove('dragover');
          const files = Array.from(event.dataTransfer.files);
          handleFiles(files);
        });

        fileInput.addEventListener('change', (event) => {
          const files = Array.from(event.target.files);
          handleFiles(files);
        });

        function handleFiles(files) {
          files.forEach(file => {
            if (!file.type.startsWith('image/')) {
              alert('이미지 파일만 업로드할 수 있습니다!');
              return;
            }

            if (currentFiles.length >= maxFiles) {
              alert(`최대 ${maxFiles}개의 이미지 파일만 업로드할 수 있습니다!`);
              return;
            }

            currentFiles.push(file);
            const reader = new FileReader();
            reader.onload = (event) => {
              const previewItem = document.createElement('div');
              previewItem.classList.add('preview-item');
              const img = document.createElement('img');
              img.src = event.target.result;

              const removeBtn = document.createElement('button');
              removeBtn.classList.add('remove-btn');
              removeBtn.textContent = 'X';
              removeBtn.addEventListener('click', () => {
                preview.removeChild(previewItem);
                currentFiles = currentFiles.filter(f => f !== file);
                updateFileInputs();
              });

              previewItem.appendChild(img);
              previewItem.appendChild(removeBtn);
              preview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
          });
          updateFileInputs();
        }

        function updateFileInputs() {
          const inputs = ['file1MF', 'file2MF', 'file3MF'].map(id => document.getElementById(id));
          inputs.forEach(input => input.value = ''); // Clear all inputs first
          currentFiles.forEach((file, index) => {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            inputs[index].files = dataTransfer.files;
          });
        }

        function back() {
          history.back();
        }
      </script>


    </div>
  </div>
</div>
</html>




